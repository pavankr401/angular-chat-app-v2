<div class="d-flex flex-column h-100">

  <div class="p-3 border-bottom bg-white d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2"
           style="width: 40px; height: 40px; font-weight: bold;">
        {{ chatTitle.charAt(0).toUpperCase() }}
      </div>
      <h6 class="m-0 fw-bold">{{ chatTitle }}</h6>
    </div>
    <button class="btn btn-sm btn-light"><i class="bi bi-three-dots-vertical"></i></button>
  </div>


  <div class="flex-grow-1 p-3 bg-light" style="overflow-y: auto;" #scrollContainer>

    <div *ngFor="let msg of messages" class="mb-2 d-flex"
         [class.justify-content-end]="msg.sender === 'me'">

      <div class="p-2 rounded shadow-sm" style="max-width: 75%; position: relative;"
           [class.bg-primary]="msg.sender === 'me'"
           [class.text-white]="msg.sender === 'me'"
           [class.bg-white]="msg.sender === 'them'">

        <div class="mb-1">

          <ng-container *ngIf="msg.type === 1">
            <div class="d-flex flex-column">

              <img [src]="fileBaseUrl + msg.text"
                   class="img-fluid rounded mb-2 border"
                   style="max-width: 200px; max-height: 200px; object-fit: cover;">

              <button class="btn btn-link btn-sm text-decoration-none p-0 text-start"
                      [class.text-white-50]="msg.sender === 'me'"
                      [class.text-muted]="msg.sender === 'them'"
                      (click)="downloadImage(fileBaseUrl + msg.text, 'image-' + msg.timestamp.getTime() + '.jpg')">
                <i class="bi bi-download"></i> Download
              </button>

            </div>
          </ng-container>

          <ng-container *ngIf="msg.type === 0 || !msg.type">
            {{ msg.text }}
          </ng-container>

        </div>

        <div class="d-flex align-items-center mt-1"
             style="font-size: 0.65rem;"
             [class.justify-content-end]="msg.sender === 'me'"
             [class.justify-content-between]="msg.sender === 'them'">

          <span *ngIf="conversation.isGroup && msg.sender === 'them'" class="fw-bold me-2"
                [class.text-muted]="true">
            {{ msg.senderName }}
          </span>

          <span [class.text-white-50]="msg.sender === 'me'" [class.text-muted]="msg.sender === 'them'">
            {{ msg.timestamp | date:'shortTime' }}
          </span>
        </div>

      </div>
    </div>

    <div *ngIf="messages.length === 0" class="text-center mt-5 text-muted">
      <small>Say hello to start the conversation!</small>
    </div>

  </div>


  <div class="p-3 bg-white border-top">
    <div class="input-group">

      <input type="file" #fileInput hidden (change)="onFileSelected($event)" accept="image/*">

      <button class="btn btn-light border" (click)="fileInput.click()" [disabled]="isUploading">
        <i class="bi" [class.bi-paperclip]="!isUploading" [class.bi-hourglass-split]="isUploading"></i>
      </button>

      <button class="btn btn-light border">
        <i class="bi bi-emoji-smile"></i>
      </button>

      <input type="text" class="form-control"
             placeholder="Type a message..."
             [(ngModel)]="newMessage"
             (keyup.enter)="sendMessage()">

      <button class="btn btn-primary" (click)="sendMessage()">
        <i class="bi bi-send-fill"></i>
      </button>

    </div>
  </div>

</div>
